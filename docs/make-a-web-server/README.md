# Make a Web server

## Why

调查 Web server 是怎么工作的。

## What is computer network

计算机之间相互连接的网络。

> <https://www.youtube.com/watch?v=tSodBEAJz9Y&list=PLF1hDMPPRqGxpYdo0ctaa7MxfOi9vjs1u&index=1>

## OSI 模型

OSI 全称 open system interconnection，即开放式系统互联参考模型。

关于网络的七层架构。

### 物理层(Physical)

物理层通过光缆、电缆、无线电波等方式将设备连接起来，从而传输比特流。

### 数据链路层(Data Link)

> 格式：|以太网头部|IP 头部|TCP/UDP 头部|应用层数据包|以太网尾部

数据链路层控制网络层与物理层之间的通信，它根据以太网协议将一组电信号组成一个数据包，称作“帧”，并控制它的传输。

- Mac 地址
  - 作用：定位数据包的路径，如发送者、接收者
  - 网卡地址，每个网卡都是独一无二的12个16进制数
    - 前6个是表厂商号，后6个是表流水号
- 广播方式：发送者把数据包，发送给局域网内的所有 PC，每个PC根据Mac地址自动匹配
  - 发送媒介是分组交换机/网络交换机

### 网络层(Network)

> 格式：|IP 头部|TCP/UDP 头部|应用层数据包

网络层最重要的作用是 IP 寻址和路由的选择。

IP 寻址方面，引入了新的地址模式-IP地址/网络地址，通过位运算（&）可以区分哪些PC是在同一子网内（ip & 255.255.255.0）。目前，IP 主要包括 IPv4 和 IPv6。

- IPv4：4字节，3字节标识网络，1字节标识主机
- IPv6：8字节

路由方面，目的是通过网络把数据从原地址发送到目标地址。

- 路由器：连接两个或多个网络并实现路由功能的机器
- 网关：网络层使用的路由器，通常指路由器的IP

#### DNS
  
### 传输层(Transport)

> 格式：|TCP/UDP头部|应用层数据包

传输层的目的是建立，维护，管理端口到端口的连接

- 端口号：取值为0-65535，0-1023为系统占用，http: 80， https: 443
- TCP：复杂，稳定，有包遗失的时候会重新发送
- UDP：简单，但不稳定，不能确定对方是否成功接收
- Socket通信时，需要指定 IP，端口号，以及通信采用的协议栈（TCP/UDP）

#### TCP 三次握手，四次挥手

> <https://zhuanlan.zhihu.com/p/53374516>

TCP 采用三次握手建立连接，采用四次挥手关闭连接。

三次握手的目的是确保双方的收发信息的能力是正常的。

第一次握手，客户端发送SYN，服务端收到，这样服务端得出结论：服务端的接收能力和客户端的发送能力是正常的；

第二次握手，服务端发送SYN+ACK，客户端收到，这样客户端得出结论：服务端的接收、发送能力正常，客户端的发送、接收能力也正常。

第三次握手，客户端发送ACK，服务端收到，这样服务端得出结论：客户端的接收、发送能力正常，服务端的接收和发送能力也正常。

三次握手之后，客户端和服务端都确定了彼此的接收和发送能力是正常的，之后就可以正常通信了。

四次挥手的目的是为了关闭双工。

第一次挥手，客户端发送 FIN 给服务端，说明客户端不必发送数据给服务器了；

第二次挥手，服务端接收到，回复 ACK，同意释放连接，客户端接收到 ACK，释放连接；

第三次挥手，服务端发送 FIN 给客户端，说明服务端不必发送数据给客户端了；

第四次挥手，客户端收到，回复 ACK，同意释放连接，服务端接收到 ACK，释放连接。

**为什么连接只需要三次，释放连接却需要四次？**

因为 TCP 是全双工模式，ACK 和 FIN 是分开发送的，即请求关闭和确认关闭是分开的。但建立连接时，服务器的SYN和ACK是同时发送的，即同意连接和请求连接是同时的，所以连接只需要三次，释放却需要四次。

**为什么连接时ACK和SYN可以一起发送，释放时则需要ACK和FIN分开发送呢？**

因为客户端请求释放时，服务端可能还有数据需要传输给客户端，因此服务端要先响应客户端FIN请求（服务端发送ACK），然后数据传输完成后，服务端在发送FIN提出FIN请求，而连接时则没有中间的数据传输，因此可以一起发送。

### 会话层(Session)，建立，维护，管理会话连接，SMTP，DNS (TCP/IP 模型没有这个)

### 表示层(Presentation)，数据的格式化，加密，解密 (TCP/IP 模型没有这个)

### 应用层(Application)，为应用程序提供网络服务，HTTP，FTP

> 格式：|应用层数据包

应用层的作用是规定应用程序的数据格式，如 ftp，http，smtp 的数据格式，从而，传输层可以按照这种格式进行信息的传递。

## Reference

1. [cerveur](https://github.com/infraredCoding/cerveur)
