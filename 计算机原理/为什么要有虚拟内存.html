<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-计算机原理/为什么要有虚拟内存">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.0">
<title data-rh="true">为什么要有虚拟内存 | C++ Interview</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://civitasv.github.io/cpp/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://civitasv.github.io/cpp/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://civitasv.github.io/cpp/计算机原理/为什么要有虚拟内存"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="为什么要有虚拟内存 | C++ Interview"><meta data-rh="true" name="description" content="原文："><meta data-rh="true" property="og:description" content="原文："><link data-rh="true" rel="icon" href="/cpp/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://civitasv.github.io/cpp/计算机原理/为什么要有虚拟内存"><link data-rh="true" rel="alternate" href="https://civitasv.github.io/cpp/计算机原理/为什么要有虚拟内存" hreflang="en"><link data-rh="true" rel="alternate" href="https://civitasv.github.io/cpp/计算机原理/为什么要有虚拟内存" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/cpp/assets/css/styles.14eff5e5.css">
<link rel="preload" href="/cpp/assets/js/runtime~main.e45f32e7.js" as="script">
<link rel="preload" href="/cpp/assets/js/main.c3bfa597.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/cpp/"><b class="navbar__title text--truncate">C++ Interview</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/cpp/">cpp</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Civitasv/cpp" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cpp/">Get Start</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/cpp">Language</a><button aria-label="Toggle the collapsible sidebar category &#x27;Language&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/stl">STL</a><button aria-label="Toggle the collapsible sidebar category &#x27;STL&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/algorithm">算法</a><button aria-label="Toggle the collapsible sidebar category &#x27;算法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/project">项目</a><button aria-label="Toggle the collapsible sidebar category &#x27;项目&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/cpp/计算机原理">计算机原理</a><button aria-label="Toggle the collapsible sidebar category &#x27;计算机原理&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/进程">进程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/计算机如何执行程序">计算机执行程序的流程</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cpp/计算机原理/为什么要有虚拟内存">为什么要有虚拟内存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/CPU 是如何执行程序的">CPU 是如何执行程序的</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/磁盘比硬盘慢几万倍">磁盘与硬盘慢几万倍</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/malloc">Malloc 内存分配</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/局部性原理">局部性原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/内存满了，会发生什么">内存满了，会发生什么</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/在 4GB 物理内存的机器上，申请 8G 内存">在 4GB 物理内存的机器上，申请 8G 内存</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/如何避免预读失效和缓存污染">如何避免预读失效和缓存污染</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/深入理解 Linux 虚拟内存管理">深入理解 Linux 虚拟内存管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cpp/计算机原理/CPU 缓存一致性">CPU 缓存一致性</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/cpp/计算机原理/CSAPP/信息的表示和处理">CSAPP</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/计算机网络">计算机网络</a><button aria-label="Toggle the collapsible sidebar category &#x27;计算机网络&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/Linux">Linux</a><button aria-label="Toggle the collapsible sidebar category &#x27;Linux&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/并行">并行计算</a><button aria-label="Toggle the collapsible sidebar category &#x27;并行计算&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/cpp/公司">公司</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/cpp/面试">面试</a><button aria-label="Toggle the collapsible sidebar category &#x27;面试&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cpp/游戏引擎/OpenGL 渲染管线">游戏引擎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cpp/阿里云/面经">阿里云</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/cpp/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/cpp/计算机原理"><span itemprop="name">计算机原理</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">为什么要有虚拟内存</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>为什么要有虚拟内存</h1><blockquote><p>原文：<a href="https://xiaolincoding.com/os/3_memory/vmem.html#%E5%86%85%E5%AD%98%E5%88%86%E6%AE%B5" target="_blank" rel="noopener noreferrer">https://xiaolincoding.com/os/3_memory/vmem.html#%E5%86%85%E5%AD%98%E5%88%86%E6%AE%B5</a></p></blockquote><p>为了管理多个进程，操作系统将进程所使用的地址<strong>隔离</strong>开来，即让操作系统为每个进程分配一套虚拟地址。而操作系统负责将不同进程的虚拟地址和不同内存的物理地址映射起来。如果程序要访问虚拟地址的时候，由操作系统转换成不同的物理地址，这样不同的进程运行的时候，写入的是不同的物理地址，这样就不会冲突了。</p><p>于是，这里就引出了两种地址的概念：</p><ol><li>我们程序所使用的内存地址叫做虚拟内存地址（Virtual Memory Address）</li><li>实际存在硬件里面的空间地址叫物理内存地址（Physical Memory Address）。</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="操作系统如何管理虚拟地址与物理地址之间的关系">操作系统如何管理虚拟地址与物理地址之间的关系<a href="#操作系统如何管理虚拟地址与物理地址之间的关系" class="hash-link" aria-label="Direct link to 操作系统如何管理虚拟地址与物理地址之间的关系" title="Direct link to 操作系统如何管理虚拟地址与物理地址之间的关系">​</a></h2><p>主要包括内存分段和内存分页两种方式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存分段">内存分段<a href="#内存分段" class="hash-link" aria-label="Direct link to 内存分段" title="Direct link to 内存分段">​</a></h2><p>程序是由若干个逻辑分段组成的，如可由代码分段、数据分段、栈段、堆段组成。不同的段是有不同的属性的，所以就用分段（Segmentation）的形式把这些段分离出来。</p><p>内存分段可能会产生内存碎片的问题。</p><p><img loading="lazy" alt="内存分段导致的外部内存碎片" src="/cpp/assets/images/2023-03-03-11-21-32-1a5ad8570ad235203b11e8d39d251388.png" width="1518" height="806" class="img_ev3q"></p><p>假设有 1G 的物理内存，用户执行了多个程序，其中：</p><p>游戏占用了 512MB 内存
浏览器占用了 128MB 内存
音乐占用了 256 MB 内存。
这个时候，如果我们关闭了浏览器，则空闲内存还有 1024 - 512 - 256 = 256MB。</p><p>如果这个 256MB 不是连续的，被分成了两段 128 MB 内存，这就会导致没有空间再打开一个 200MB 的程序。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="内存分段会出现内存碎片吗">内存分段会出现内存碎片吗？<a href="#内存分段会出现内存碎片吗" class="hash-link" aria-label="Direct link to 内存分段会出现内存碎片吗？" title="Direct link to 内存分段会出现内存碎片吗？">​</a></h3><p>内存碎片主要分为，内部内存碎片和外部内存碎片。</p><p>内存分段管理可以做到段根据实际需求分配内存，所以有多少需求就分配多大的段，所以不会出现内部内存碎片。</p><p>但是由于每个段的长度不固定，所以多个段未必能恰好使用所有的内存空间，会产生了多个不连续的小物理内存，导致新的程序无法被装载，所以会出现外部内存碎片的问题。</p><p><strong>解决「外部内存碎片」的问题就是内存交换。</strong></p><p>可以把音乐程序占用的那 256MB 内存写到硬盘上，然后再从硬盘上读回来到内存里。不过再读回的时候，我们不能装载回原来的位置，而是紧紧跟着那已经被占用了的 512MB 内存后面。这样就能空缺出连续的 256MB 空间，于是新的 200MB 程序就可以装载进来。</p><p>这个内存交换空间，在 Linux 系统里，也就是我们常看到的 Swap 空间，这块空间是从硬盘划分出来的，用于内存与硬盘的空间交换。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="内存分段为什么会导致内存交换效率低">内存分段为什么会导致内存交换效率低？<a href="#内存分段为什么会导致内存交换效率低" class="hash-link" aria-label="Direct link to 内存分段为什么会导致内存交换效率低？" title="Direct link to 内存分段为什么会导致内存交换效率低？">​</a></h3><p>对于多进程的系统来说，应用内存分段的策略下，外部内存碎片是很容易产生的，产生了外部内存碎片，就不得不重新 swap 内存区域，这个过程会产生性能瓶颈。</p><p>因为硬盘的访问速度要比内存慢太多了，每一次内存交换，都需要把一大段连续的内存数据写到硬盘上。所以，如果内存交换的时候，交换的是一个占内存很大的程序，这样整个机器都会卡顿。</p><p>正因如此，就出现了内存分页。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="内存分页">内存分页<a href="#内存分页" class="hash-link" aria-label="Direct link to 内存分页" title="Direct link to 内存分页">​</a></h2><p>分段的好处是能产生连续的内存空间，但是会出现「外部内存碎片和内存交换的空间太大」的问题。</p><p>为解决该问题：</p><ol><li>尽量减少内存碎片</li><li>需要进行内存交换的时候，与磁盘交换的数据要小一些</li></ol><p>这个方法就是内存分页（Paging）。</p><p>分页是把整个虚拟和物理内存空间切成一段段固定尺寸的大小，这样一个连续并且尺寸固定的内存空间，我们叫做页（Page）。在 Linux 下，每一页的大小为 4kb。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分页是怎么解决分段的外部内存碎片和内存交换效率低的问题">分页是怎么解决分段的「外部内存碎片和内存交换效率低」的问题？<a href="#分页是怎么解决分段的外部内存碎片和内存交换效率低的问题" class="hash-link" aria-label="Direct link to 分页是怎么解决分段的「外部内存碎片和内存交换效率低」的问题？" title="Direct link to 分页是怎么解决分段的「外部内存碎片和内存交换效率低」的问题？">​</a></h3><p>内存分页由于内存空间都是预先划分好的，也就不会像内存分段一样，在段与段之间会产生间隙非常小的内存，这正是分段会产生外部内存碎片的原因。而采用了分页，页与页之间是紧密排列的，所以不会有外部碎片。</p><p>但是，因为内存分页机制分配内存的最小单位是一页，即使程序不足一页大小，我们最少只能分配一个页，所以页内会出现内存浪费，所以针对内存分页机制会有内部内存碎片的现象。</p><p>如果内存空间不够，操作系统会把其他正在运行的进程中的「最近没被使用」的内存页面给释放掉，也就是暂时写在硬盘上，称为换出（Swap Out）。一旦需要的时候，再加载进来，称为换入（Swap In）。所以，一次性写入磁盘的也只有少数的一个页或者几个页，不会花太多时间，内存交换的效率就相对比较高。</p><p><img loading="lazy" alt="分页机制下的虚拟地址与物理地址映射" src="/cpp/assets/images/2023-03-10-13-39-37-57d87dfec36e15eca59f03c221c8032e.png" width="1067" height="797" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多级页表">多级页表<a href="#多级页表" class="hash-link" aria-label="Direct link to 多级页表" title="Direct link to 多级页表">​</a></h3><p>利用了计算机中无所不在的局部性原理。</p><p><img loading="lazy" alt="多级页表" src="/cpp/assets/images/2023-03-10-13-42-16-41e08978887e8d6f5a77a80538a88bee.png" width="1686" height="1146" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="tlb">TLB<a href="#tlb" class="hash-link" aria-label="Direct link to TLB" title="Direct link to TLB">​</a></h4><p>多级页表虽然解决了空间上的问题，但是虚拟地址到物理地址的转换效率就低了。计算机科学家们就在 CPU 芯片中，加入了一个专门存放程序最常访问的页面项的 Cache，这个 Cache 就是 TLB（Translation Lookaside Buffer, 页表缓存）</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="段页式内存管理">段页式内存管理<a href="#段页式内存管理" class="hash-link" aria-label="Direct link to 段页式内存管理" title="Direct link to 段页式内存管理">​</a></h2><p>内存分段和内存分页并不是对立的，它们是可以组合起来在同一个系统中使用的。</p><ul><li>先将程序划分为多个有逻辑意义的段</li><li>接着再把每个段划分为多个页，也就是对分段划分出来的连续空间，再划分为固定大小的页</li></ul><p>段页式地址变换中要得到物理地址须经过三次内存访问：</p><ul><li>第一次访问段表，得到页表起始地址；</li><li>第二次访问页表，得到物理页号；</li><li>第三次将物理页号与页内位移组合，得到物理地址。</li></ul><p>可用软、硬件相结合的方法实现段页式地址变换，这样虽然增加了硬件成本和系统开销，但提高了内存的利用率。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="linux-系统中的内存布局">Linux 系统中的内存布局<a href="#linux-系统中的内存布局" class="hash-link" aria-label="Direct link to Linux 系统中的内存布局" title="Direct link to Linux 系统中的内存布局">​</a></h2><p>Linux 系统中的每个段都是从 0 地址开始的整个 4GB 虚拟空间（32 位环境下），也就是所有的段的起始地址都是一样的。这意味着，Linux 系统中的代码，包括操作系统本身的代码和应用程序代码，所面对的地址空间都是线性地址空间（虚拟地址），这种做法相当于屏蔽了处理器中的逻辑地址概念，段只被用于访问控制和内存保护。</p><p>相当于只存在一个内存分段，实际使用时，会根据页表映射到相应的物理内存。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="虚拟内存有什么作用">虚拟内存有什么作用？<a href="#虚拟内存有什么作用" class="hash-link" aria-label="Direct link to 虚拟内存有什么作用？" title="Direct link to 虚拟内存有什么作用？">​</a></h2><ol><li>第一，虚拟内存可以使得进程对运行内存超过物理内存大小，因为程序运行符合局部性原理，CPU 访问内存会有很明显的重复访问的倾向性，对于那些没有被经常使用到的内存，我们可以把它换出到物理内存之外，比如硬盘上的 swap 区域。</li><li>第二，由于每个进程都有自己的页表，所以每个进程的虚拟内存空间就是相互独立的。进程也没有办法访问其他进程的页表，所以这些页表是私有的，这就解决了多进程之间地址冲突的问题。</li><li>第三，页表里的页表项中除了物理地址之外，还有一些标记属性的比特，比如控制一个页的读写权限，标记该页是否存在等。在内存访问方面，操作系统提供了更好的安全性。</li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/cpp/计算机原理/计算机如何执行程序"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">计算机执行程序的流程</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cpp/计算机原理/CPU 是如何执行程序的"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">CPU 是如何执行程序的</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#操作系统如何管理虚拟地址与物理地址之间的关系" class="table-of-contents__link toc-highlight">操作系统如何管理虚拟地址与物理地址之间的关系</a></li><li><a href="#内存分段" class="table-of-contents__link toc-highlight">内存分段</a><ul><li><a href="#内存分段会出现内存碎片吗" class="table-of-contents__link toc-highlight">内存分段会出现内存碎片吗？</a></li><li><a href="#内存分段为什么会导致内存交换效率低" class="table-of-contents__link toc-highlight">内存分段为什么会导致内存交换效率低？</a></li></ul></li><li><a href="#内存分页" class="table-of-contents__link toc-highlight">内存分页</a><ul><li><a href="#分页是怎么解决分段的外部内存碎片和内存交换效率低的问题" class="table-of-contents__link toc-highlight">分页是怎么解决分段的「外部内存碎片和内存交换效率低」的问题？</a></li><li><a href="#多级页表" class="table-of-contents__link toc-highlight">多级页表</a></li></ul></li><li><a href="#段页式内存管理" class="table-of-contents__link toc-highlight">段页式内存管理</a></li><li><a href="#linux-系统中的内存布局" class="table-of-contents__link toc-highlight">Linux 系统中的内存布局</a></li><li><a href="#虚拟内存有什么作用" class="table-of-contents__link toc-highlight">虚拟内存有什么作用？</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/cpp/index">C++</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/Civitasv/cpp" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Civitasv, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/cpp/assets/js/runtime~main.e45f32e7.js"></script>
<script src="/cpp/assets/js/main.c3bfa597.js"></script>
</body>
</html>